{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block page %}
<div class="row q-col-gutter-md justify-center">
  <div class="col q-gutter-y-md">
    <q-btn label="Save" flat @click="updateSettings"></q-btn>
    <q-btn label="Restart server" flat @click="restartServer"></q-btn>
    <q-btn label="Reset to defaults" flat @click="deleteSettings"></q-btn>
    <q-btn
      label="Download Database Backup"
      flat
      @click="downloadBackup"
    ></q-btn>
  </div>
</div>
<div class="row q-col-gutter-md justify-center">
  <div class="col q-gutter-y-md">
    <q-card>
      <div class="q-pa-md">
        <div class="q-gutter-y-md">
          <q-tabs v-model="tab" active-color="primary" align="justify">
            <q-tab
              name="funding"
              label="Funding"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="users"
              label="Users"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="server"
              label="Server"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="theme"
              label="Theme"
              @update="val => tab = val.name"
            ></q-tab>
          </q-tabs>
        </div>
      </div>
      <q-form name="settings_form" id="settings_form">
        <q-tab-panels v-model="tab" animated>
          {% include "admin/_tab_funding.html" %} {% include
          "admin/_tab_users.html" %} {% include "admin/_tab_server.html" %} {%
          include "admin/_tab_theme.html" %}
        </q-tab-panels>
      </q-form>
    </q-card>
  </div>
</div>

{% endblock %} {% block scripts %} {{ window_vars(user) }}
<script>
  new Vue({
    el: '#vue',
    mixins: [windowMixin],
    data: function () {
      return {
        settings: {},
        data: {},
        wallet: {},
        cancel: {},
        tab: 'funding'
      }
    },
    created: function () {
      this.data.settings = JSON.parse('{{ settings|tojson|safe }}')
      this.data.balance = {{ balance|safe }}
      console.log(this.data.settings, this.data.balance)
    },
    methods: {
      addAdminUser() {
        let addUser = this.data.admin_users_add
        let admin_users = this.data.admin.admin_users
        if (addUser && addUser.length && !admin_users.includes(addUser)) {
          admin_users.push(addUser)
          this.data.admin.admin_users = admin_users
          this.data.admin_users_add = ''
        }
      },
      removeAdminUser(user) {
        let admin_users = this.data.admin.admin_users
        this.data.admin.admin_users = admin_users.filter(u => u !== user)
      },
      addAllowedUser() {
        let addUser = this.data.allowed_users_add
        let allowed_users = this.data.admin.allowed_users
        if (addUser && addUser.length && !allowed_users.includes(addUser)) {
          allowed_users.push(addUser)
          this.data.admin.allowed_users = allowed_users
          this.data.allowed_users_add = ''
        }
      },
      removeAllowedUser(user) {
        let allowed_users = this.data.admin.allowed_users
        this.data.admin.allowed_users = allowed_users.filter(u => u !== user)
      },
      addAdSpace() {
        let adSpace = this.data.ad_space_add
        let spaces = this.data.admin.ad_space
        if (adSpace.length && !spaces.includes(adSpace)) {
          spaces.push(adSpace)
          this.data.admin.ad_space = spaces
          this.data.ad_space_add = ''
        }
      },
      removeAdSpace(ad) {
        let spaces = this.data.settings.lnbits_ad_space
        this.data.admin.ad_space = spaces.filter(s => s !== ad)
      },
      restartServer() {
        LNbits.api
          .request(
            'GET',
            '/admin/api/v1/restart/?usr=' + this.g.user.id,
          )
          .then(response => {
            this.$q.notify({
              type: 'positive',
              message: 'Success! Restarted Server',
              icon: null
            })
          })
          .catch(function (error) {
            LNbits.utils.notifyApiError(error)
          })
      },
      topupWallet() {
        LNbits.api
          .request(
            'POST',
            '/admin/api/v1/topup/?usr=' + this.g.user.id,
            this.wallet.id,
            this.wallet.amount,
          )
          .then(response => {
            this.$q.notify({
              type: 'positive',
              message:
                'Success! Added ' +
                this.wallet.amount +
                ' to ' +
                this.wallet.id,
              icon: null
            })
            this.wallet = {}
          })
          .catch(function (error) {
            LNbits.utils.notifyApiError(error)
          })
      },
      updateSettings() {
        const formElement = document.getElementById('settings_form');
        const formData = new FormData(formElement);
        const data = {};
        formData.forEach((value, key) => (data[key] = value));
        // only for debugging
        for (const [key, value] of formData) {
            console.log(`${key}: ${value}\n`);
        }
        LNbits.api
          .request(
            'PUT',
            '/admin/api/v1/settings/?usr=' + this.g.user.id,
            this.g.user.wallets[0].adminkey,
            data
          )
          .then(response => {
            this.$q.notify({
              type: 'positive',
              message: 'Success! Settings changed!',
              icon: null
            })
          })
          .catch(function (error) {
            LNbits.utils.notifyApiError(error)
          });
      },
      deleteSettings() {
        LNbits.api
          .request(
            'DELETE',
            '/admin/api/v1/settings/?usr=' + this.g.user.id
          )
          .then(response => {
            this.$q.notify({
              type: 'positive',
              message: 'Success! Restored settings to defaults, restart required!',
              icon: null
            })
          })
          .catch(function (error) {
            LNbits.utils.notifyApiError(error)
          });
      },
      downloadBackup() {
        LNbits.api
          .request(
            'GET',
            '/admin/api/v1/backup/?usr=' + this.g.user.id
          )
          .then(response => {
            this.$q.notify({
              type: 'positive',
              message: 'Success! Database backup request, download starts soon!',
              icon: null
            })
          })
          .catch(function (error) {
            LNbits.utils.notifyApiError(error)
          });
      }
    }
  })
</script>
{% endblock %}
