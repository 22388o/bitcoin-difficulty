{% extends "public.html" %} {% block page %}
<div class="row items-center q-mt-md">
  <div class="col-lg-4 col-md-3 col-sm-1"></div>
  <div class="col-lg-4 col-md-6 col-sm-10">
    <q-card>
      <div class="column">
        <center>
          <div class="col">
            <span class="text-h4" v-text="charge.description"></span>
          </div>
        </center>
        <div class="col">
          <div
            class="col"
            color="white"
            style="background-color: grey; height: 30px; padding: 5px"
            v-if="timetoComplete < 1"
          >
            <center>Time elapsed</center>
          </div>
          <div
            class="col"
            color="white"
            style="background-color: grey; height: 30px; padding: 5px"
            v-else-if="charge.paid"
          >
            <center>Charge paid</center>
          </div>
          <div v-else>
            <q-linear-progress size="30px" :value="newProgress" color="grey">
              <q-item-section>
                <q-item style="padding: 3px">
                  <q-spinner color="white" size="0.8em"></q-spinner
                  ><span style="font-size: 15px; color: white"
                    ><span class="q-pr-xl q-pl-md"> Awaiting payment...</span>
                    <span class="q-pl-xl" style="color: white">
                      {% raw %} {{ newTimeLeft }} {% endraw %}</span
                    ></span
                  >
                </q-item>
              </q-item-section>
            </q-linear-progress>
          </div>
        </div>
        <div class="col" style="margin: 2px 15px; max-height: 100px">
          <div class="row items-center">
            <div class="col-4 q-pr-lg">Charge Id:</div>
            <div class="col-8 q-pr-lg">
              <q-btn flat dense outline @click="copyText(charge.id)"
                ><span v-text="charge.id"></span
              ></q-btn>
            </div>
          </div>
          <div class="row items-center">
            <div class="col-4 q-pr-lg">Total to pay:</div>
            <div class="col-8 q-pr-lg">
              <span v-text="charge.amount"></span> sats
            </div>
          </div>
          <div class="row items-center">
            <div class="col-4 q-pr-lg">Amount paid:</div>
            <div class="col-8 q-pr-lg">
              <span v-text="charge.balance"></span> sats
            </div>
          </div>
          <div class="row items-center">
            <div class="col-4 q-pr-lg">Amount due:</div>
            <div class="col-8 q-pr-lg">
              <span
                v-if="charge.amount - charge.balance > 0"
                v-text="charge.amount - charge.balance"
                >sats</span
              >
              <q-badge v-if="charge.amount - charge.balance <= 0" color="green">
                none</q-badge
              >
            </div>
          </div>
        </div>
        <q-separator></q-separator>
        <div class="col">
          <div class="row">
            <div class="col">
              <q-btn
                flat
                disable
                v-if="!charge.lnbitswallet || charge.time_elapsed"
                style="color: primary; width: 100%"
                label="lightning⚡"
              >
                <q-tooltip>
                  bitcoin lightning payment method not available
                </q-tooltip>
              </q-btn>
              <q-btn
                flat
                v-else
                @click="payInvoice"
                style="color: primary; width: 100%"
                label="lightning⚡"
              >
                <q-tooltip> pay with lightning </q-tooltip>
              </q-btn>
            </div>
            <div class="col">
              <q-btn
                flat
                disable
                v-if="!charge.onchainwallet || charge.time_elapsed"
                style="color: primary; width: 100%"
                label="onchain⛓️"
              >
                <q-tooltip>
                  bitcoin onchain payment method not available
                </q-tooltip>
              </q-btn>
              <q-btn
                flat
                v-else
                @click="payOnchain"
                style="color: primary; width: 100%"
                label="onchain⛓️"
              >
                <q-tooltip> pay onchain </q-tooltip>
              </q-btn>
            </div>
          </div>
          <q-separator></q-separator>
        </div>
      </div>
    </q-card>
    <q-card class="q-pa-lg" v-if="lnbtc">
      <q-card-section class="q-pa-none">
        <div class="row items-center q-mt-sm">
          <div class="col-md-2 col-sm-0"></div>
          <div class="col-md-8 col-sm-12">
            <div v-if="timetoComplete < 1 && !charge.paid">
              <q-icon
                name="block"
                style="color: #ccc; font-size: 21.4em"
              ></q-icon>
            </div>
            <div v-else-if="charge.paid">
              <q-icon
                name="check"
                style="color: green; font-size: 21.4em"
              ></q-icon>
              <q-btn
                outline
                v-if="charge.webhook"
                type="a"
                :href="charge.completelink"
                :label="charge.completelinktext"
              ></q-btn>
            </div>
            <div v-else>
              <div class="row text-center q-mb-sm">
                <div class="col text-center">
                  <span class="text-subtitle2"
                >Pay this lightning-network invoice:</span
              >
                </div></div>
              

              <a :href="'lightning:'+charge.payment_request">
                <q-responsive :ratio="1" class="q-mx-md">
                  <qrcode
                    :value="charge.payment_request"
                    :options="{width: 800}"
                    class="rounded-borders"
                  ></qrcode>
                </q-responsive>
              </a>
              <div class="row text-center q-mt-lg">
                <div class="col text-center">
                <q-btn
                  outline
                  color="grey"
                  @click="copyText(charge.payment_request)"
                  >Copy invoice</q-btn
                >
              </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2 col-sm-0"></div>
      </q-card-section>
    </q-card>
    <q-card class="q-pa-lg" v-if="onbtc">
      <q-card-section class="q-pa-none">
        <div  v-if="timetoComplete >= 0 && !charge.paid" class="row items-center">
          <div class="col text-center">
            <span class="text-subtitle1" v-text="charge.onchainaddress"></span>
          </div>
        </div>
        <div class="row items-center q-mt-md">
          <div class="col-md-2 col-sm-0"></div>
          <div class="col-md-8 col-sm-12">
            <div v-if="timetoComplete < 1 && !charge.paid">
              <q-icon
                name="block"
                style="color: #ccc; font-size: 21.4em"
              ></q-icon>
            </div>
            <div v-else-if="charge.paid">
              <q-icon
                name="check"
                style="color: green; font-size: 21.4em"
              ></q-icon>
              <q-btn
                outline
                v-if="charge.webhook"
                type="a"
                :href="charge.completelink"
                :label="charge.completelinktext"
              ></q-btn>
            </div>
            <div v-else>
              <div class="row items-center q-mb-sm">
                <div class="col text-center">
                  <span class="text-subtitle2"
                    >Send

                    <span v-text="charge.amount"></span>
                    sats to this onchain address</span
                  >
                </div>
              </div>

              <a :href="'bitcoin:'+charge.onchainaddress">
                <q-responsive :ratio="1" class="q-mx-md">
                  <qrcode
                    :value="charge.onchainaddress"
                    :options="{width: 800}"
                    class="rounded-borders"
                  ></qrcode>
                </q-responsive>
              </a>
              <div class="row items-center q-mt-lg">
                <div class="col text-center">
                  <q-btn
                    outline
                    color="grey"
                    @click="copyText(charge.onchainaddress)"
                    >Copy address</q-btn
                  >
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-sm-0"></div>
        </div>
      </q-card-section>
    </q-card>
  </div>
  <div class="col-lg- 4 col-md-3 col-sm-1"></div>
</div>

{% endblock %} {% block scripts %}

<script src="https://mempool.space/mempool.js"></script>
<script src="{{ url_for('satspay_static', path='js/utils.js') }}"></script>
<script>
  Vue.component(VueQrcode.name, VueQrcode)

  new Vue({
    el: '#vue',
    mixins: [windowMixin],
    data() {
      return {
        charge: JSON.parse('{{charge_data | tojson}}'),
        ws: null,
        newProgress: 0.4,
        counter: 1,
        newTimeLeft: '',
        timetoComplete: 100,
        lnbtc: true,
        onbtc: false,
        wallet: {
          inkey: ''
        },
        cancelListener: () => {}
      }
    },
    methods: {
      startPaymentNotifier() {
        this.cancelListener()
        if (!this.lnbitswallet) return
        this.cancelListener = LNbits.events.onInvoicePaid(
          this.wallet,
          payment => {
            this.checkInvoiceBalance()
          }
        )
      },
      checkBalances: async function () {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            `/satspay/api/v1/charges/balance/${this.charge.id}`,
            'filla'
          )

          this.charge.time_elapsed = data.time_elapsed
          this.charge.amount = data.amount
          this.charge.balance = data.balance
          if (this.charge.balance >= this.charge.amount) {
            this.charge.paid = true
          }
        } catch (error) {
          LNbits.utils.notifyApiError(error)
        }
      },
      payInvoice: function () {
        this.lnbtc = true
        this.onbtc = false
      },
      payOnchain: function () {
        this.lnbtc = false
        this.onbtc = true
      },
      refreshExpirationTime: function () {
        this.timetoComplete =
          parseInt(this.charge.time) * 60 -
          (Date.now() / 1000 - parseInt(this.charge.timestamp))

        this.newTimeLeft = Quasar.utils.date.formatDate(
          new Date((this.timeToComplete - 3600) * 1000),
          'HH:mm:ss'
        )
      },
      refreshProgres: function () {
        this.refreshExpirationTime()
        this.newProgress =
          1 - this.timeToComplete / (parseInt(this.charge.time) * 60)
      },
      loopRefresh: function () {
        // invoice only
        const refreshIntervalId = setInterval(async () => {
          console.log('### 1111')
          if (this.charge.paid || this.timetoComplete < 1) {
            clearInterval(refreshIntervalId)
          }
          this.refreshProgres()
          if (this.counter % 10 === 0) {
            console.log('### 11110')
            await this.checkBalances()
          }
          this.counter++
        }, 1000)
      },
      initWs: async function () {
        const {
          bitcoin: {websocket}
        } = mempoolJS({
          hostname: 'mempool.space'
        })

        this.ws = new WebSocket('wss://mempool.space/api/v1/ws')
        this.ws.addEventListener('open', x => {
          console.log('### open ws', x)
        })
        this.ws.addEventListener('close', x => {
          console.log('### close ws', x)
        })

        this.ws.addEventListener('message', ({data}) => {
          const res = JSON.parse(data.toString())
          console.log('### socker mempool res', res)
          if (res['address-transactions']) {
          }
        })
      },
      loopPingWs: function () {
        setInterval(() => {
          if (!this.ws || this.ws.readyState !== WebSocket.OPEN) this.initWs()
          this.ws.send(JSON.stringify({action: 'ping'}))
        }, 30 * 1000)
      },
      trackAddress: async function (address, retry = 0) {
        try {
          if (!this.ws || this.ws.readyState !== WebSocket.OPEN) this.initWs()
          console.log('### start to track: ', address)
          this.ws.send(JSON.stringify({'track-address': address}))
        } catch (error) {
          await sleep(1000)
          if (retry > 10) throw error
          this.trackAddress(address, retry + 1)
        }
      }
    },
    created: async function () {
      console.log('### charge', this.charge)
      if (this.charge.lnbitswallet) this.payInvoice()
      else this.payOnchain()
      await this.checkBalances()

      // empty for onchain
      this.wallet.inkey = '{{ wallet_inkey }}'
      this.startPaymentNotifier()

      this.refreshProgres()
      if (!this.charge.paid) {
        this.loopRefresh()
      }

      if (this.charge.onchainaddress) {
        this.loopPingWs()
        this.trackAddress(this.charge.onchainaddress)
      }
    }
  })
</script>
{% endblock %}
